\chapter{Matrix form}\label{chap:matrices}
The original ZH-calculus completeness proof relied on rewriting to a normal form
which essentially represented the underlying matrix directly. While we can't
repeat the full result here for lack of the parametrised axioms it's based on,
we can define a matrix form, represent some numbers and some matrices, and
rewrite some diagrams to their corresponding matrices. This allows us to
construct equality proofs for some diagrams which have proven otherwise
intractable. Note that this purely syntactic sugar; everything defined in this
chapter is defined in terms of the phasefree ZH-calculus, and all proofs can be
translated back to yield valid though potentially lengthy proofs.

\section{Numbers}
\ROUGH{
First, we'll define a few formal "numbers" in our calculus (we can define more
later, but these will illustrate our setup nicely). Because our numbers are going
to be used as entries in a matrix, rather than as direct scalars, they'll need
to have at least one edge wire to connect to for manipulation. In fact, we'll
give them all exactly one output wire, and then define how to turn that into any
number of input and output wires. 
}

\begin{definition}
    A \textbf{number state} is a diagram
    $$\tikzfig{numstate} \text{ satisfying } \tikzfig{numstatedef}$$
    A \textbf{number} is a diagram 
    $$\tikzfig{numdef}$$
    up to diagrammatic equality, where $\tikzfig{numstate}$ is a number state.
\end{definition}
\begin{remark*}
    The diagrammatic equality provision, besides keeping our meaning of equality
    consistent, also means that all number states are, in fact, numbers.
\end{remark*}

Informally, we want to choose our number states such that plugging
$\tikzfig{notmeasure}$ into them yields a scalar whose standard interpretation
equals the complex number we've named our number state for. That is, we want
$$\forall \hnum{a} \intf{\tikzfig{num-a-scalar}} = a$$
Some examples of diagrams satisfying these constraints are
$$\tikzfig{numdefs}$$
It's easy to check in the full ZH-calculus that these equal the parametrized
H-boxes they replace. In particular, setting $\hnum{a} = \hnum{1}$ in the last
rule also gives us
$$\tikzfig{minusone}$$


\section{Matrices}\label{sec:matrices}
Recall that the original ZH-calculus in \cite{backens2018zhcalculus} used
indexing maps to define normal forms.  Since those maps did not use parameters
anywhere, we can use them here as well.  For completeness' sake, we repeat the
definition:
$$\tikzfig{bitmaskdef}$$
Where $\tikzfig{nottofirst}$ and $\tikzfig{nottozeroth}$ . We'll also want the
binary representation function 
$b^n : \mathbb{N} \rightarrow \mathbb{B}^n, i \mapsto \left( \left \lfloor
\frac{i}{2^{n-1}}\right \rfloor \text{mod } i \right) \ldots \left( \left \lfloor
\frac{i}{2^{0}}\right \rfloor \text{mod } i \right)$ . Where $n$ is obvious or
irrelevant, we'll leave it implicit, $b^n =: b$.

Now that we have both numbers and indices, we can define matrices within the
phasefree ZH-calculus:
\begin{definition}
    A diagram is said to be in \textbf{matrix form} (and is called a
    \textbf{matrix diagram}) if it matches
    $$\tikzfig{matrix-M-diag-expanded}$$
    And any such diagram may be written in shorthand as 
    $$\tikzfig{matrix-diag-def}$$

    Furthermore, a diagram is said to be in \textbf{normal form} if it is in
    matrix form and has no input wires, matching the shape of normal forms in
    \cite{backens2018zhcalculus}.
\end{definition}

Since this produces $O(n^2)$ nodes and $O(n^3)$ wires for maps $\mathbb{C}^n
\rightarrow \mathbb{C}^n$, this clearly doesn't produce very tractable diagrams
when we need to expand a matrix into its definition. Worse, some of the more
useful tricks cause a lot of $\hnum{1}$ entries in intermediate steps next to
the entries we're actually interested in (this is because $\hnum{1}$ is the
pointwise multiplicative identity, allowing us to construct diagrams by taking
Schur products of simpler diagrams). To mitigate this at least slightly (and in
specific cases we're interested in, significantly), we make the following
observation: 
\begin{lemma}
    Given $n,m \in \mathbb{N}, B \subset {1 \ldots n} \times {1 \ldots m}, A =
    {1 \ldots n} \times {1 \ldots m}\\B$, we have 
    $$\tikzfig{rednormal-rule}$$
\end{lemma}
\begin{proof}
    $$\tikzfig{rednormal-proof}$$
\end{proof}

Based on this, we add the following definition
\begin{definition}
    A diagram is said to be \textbf{reduced matrix form} if it's equal to a
    matrix form with all elements corresponding to \hnum{1} removed. More
    generally, any variation on matrix forms can be \textbf{reduced} by removing
    all elements corresponding to \hnum{1}.
\end{definition}

\section{Calculation}\label{sec:calculation}
Given the notation above, we can add some limited arithmetic and basic
manipulations. Specifically, we'll define the product and the average on
numbers, prove some results mirroring extension, contraction, and convolution
from \cite{backens2018zhcalculus} and precompute the product and average for the
most useful cases.

\begin{definition}
    If \hnum{a} and \hnum{b} are defined, then \hnum{a \star b} is defined as
    $$\tikzfig{num-prod-def}$$
\end{definition}

\begin{definition}
    If \hnum{a} and \hnum{b} are defined, then \hnum{AVG(a, b)} is defined as
    $$\tikzfig{num-avg-def}$$
\end{definition}


\section{Trinary matrices}

\begin{definition}
    A matrix \tikzfig{indexed-matrix-M} is called a \textbf{trinary matrix} if%
    $\forall i,j \in \underline{n} \prod \underline{m}, M_{i,j} \in \{\hnum{-1},%
    \hnum{0},\hnum{1}\}$. A diagram in (reduced) matrix or normal form described
    by a trinary matrix is in (reduced) \textbf{trinary matrix form} resp.
    \textbf{trinary normal form} .
\end{definition}

\begin{lemma}\label{lem:extclosed}
    Given a diagram \tikzfig{normal-S-diag} in trinary normal form, we can bring
    \tikzfig{normal-S-extend} into trinary normal form.
\end{lemma}
\begin{proof}
\end{proof}
\begin{corollary}
    Since bending and swapping wires merely rearranges index bits without
    destroying the matrix form, we can generalize the above to all matrices and
    arbitrary positions of the extension by transforming to and from normal
    form. So, for any trinary matrix $M$ and $i, j \geq 0$, there are trinary
    matrices $M'$ and $M''$ with
    $$\tikzfig{matrix-M-extend} = \tikzfig{matrix-Mprime} \text{and}%
    \tikzfig{matrix-M-extend-down} = \tikzfig{matrix-Mdoubleprime}$$
\end{corollary}

\begin{TODOLIST}
    Write meta-lemmata as discussed
    \begin{enumerate}
        \item Extension on \{\hnum{-1},\hnum{0},\hnum{1}\} is closed.
        \item Convolution on \{\hnum{-1},\hnum{0},\hnum{1}\} is closed.
        \item Contraction on \{\hnum{-1},\hnum{0},\hnum{1}\} goes to %
            \{\hnum{-2},\hnum{-1},\hnum{0},\hnum{1},\hnum{2}\}.
        \item Given unique number representations, matrices are unique.
        \item \{\hnum{-2},\hnum{-1},\hnum{0},\hnum{1},\hnum{2}\} form %
            a set of unique number representations by the soundness of the %
            calculus.
        \item The previous 3 statements give the uniqueness of diagrams w.r.t. %
            $\intf{-}$ after contraction on a trinary matrix
        \item Since $\intf{\tikzfig{h-toffoli}} =
            \intf{\tikzfig{triangle-toffoli}} $, the above gives that
            \tikzfig{h-toffoli} = \tikzfig{triangle-toffoli} by turning both
            into quintary matrices: first extend and convolve to trinary
            matrices, then contract once to get a quintary matrix (which is in
            fact a trinary matrix, but that is a happy coincidence).
    \end{enumerate}
\end{TODOLIST}

\begin{TODOLIST}
    Write meta-lemmata as already used informally.
    \begin{enumerate}
        \item Some numbers can be assigned a formal representation
        \item (reduced) normal forms can be written as a matrix of formally %
            represented numbers
        \item Schur products of normal forms can be computed pointwise,
            including in their matrix representation (straight from ZH2018)
        \item The generalised ortho rule/splitting lemma lets us do the
            topological part of contraction.
        \item For some matrices, including those only containing \{-1, 0, 1\}, we
            can prove the cases of the (A) rule needed to do the computational
            part of contraction
        \item We can de-introduce a factor $\frac{1}{2}$
    \end{enumerate}
\end{TODOLIST}

\section{Proving the (\&) rule}

\subsection{Pre-matrix steps}
First, we need to bring the diagrams into a shape that our tools can deal with,
since sequential composition isn't directly supported. Since the upper leg of
the left-hand side is not in reduced normal form, we'll first find that so we
can replace it in the diagram.\\
$\tikzfig{down-triangle-inv-to-rednorm}$
Now we can prepare the left-hand side:\\
$\tikzfig{and-lhs}$ 
$= \tikzfig{and-lhs-seq-rednorm}$ 
$= \tikzfig{and-lhs-star-rednorm}$
And doing the same for the right-hand side:
$\tikzfig{and-rhs}$
$= \tikzfig{and-rhs-star-rednorm}$\\

\subsection{Calculating the matrix}
Using our earlier theorems, we can now write the above equations in matrix
form:\\
$\tikzfig{and-lhs-small-matrices}$
$= $
